<!DOCTYPE html>
<html>
  <head>
    <title>Multiplayer Experiment</title>
    <script src='jspsych/jspsych.js'></script>
    <script src="socket.io/socket.io.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-external-html.js"></script>
    <script src="jspsych/plugins/jspsych-multi-experiment.js"></script>
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <script src="jspsych/plugins/jspsych-survey-html-form.js"></script>
    <script src="jspsych/plugins/jspsych-audio-button-response.js"></script>
    <script src="jspsych/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-image-button-response.js"></script>
    <script src="jspsych/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych/plugins/jspsych-multi-training.js"></script>


    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  </head>
  <body> </body>

<script>

//setting up variables that will be used throughout the experiment
var num_players = 4;
var num_test_trials = 32;
//how many players can we lose before needing to call off the experiment - i think we're only using even numbers so don't need to worry too much about this
var able_to_lose = num_players/2;

var socket = io();
var timeline = [];
var test_audio = ["stimuli/1.wav", "stimuli/2.wav", "stimuli/3.wav", "stimuli/4.wav",
                "stimuli/5.wav", "stimuli/6.wav", "stimuli/7.wav", "stimuli/8.wav",
                "stimuli/9.wav", "stimuli/10.wav", "stimuli/11.wav", "stimuli/12.wav",
                "stimuli/13.wav", "stimuli/14.wav", "stimuli/15.wav", "stimuli/16.wav"];
var trial_audio;
var cardStim = ["stimuli/1001.jpg", "stimuli/2001.jpg", "stimuli/3001.jpg", "stimuli/4001.jpg"]
var audioTest = ['stimuli/antiphase_HC_IOS.wav', 'stimuli/antiphase_HC_ISO.wav', 'stimuli/antiphase_HC_OIS.wav',
                  'stimuli/antiphase_HC_OSI.wav', 'stimuli/antiphase_HC_SIO.wav', 'stimuli/antiphase_HC_SOI.wav'];

var audioTestCorrect = [{audio: audioTest[0], correct: 2}, {audio: audioTest[1], correct: 1}, {audio: audioTest[2], correct: 2},
                        {audio: audioTest[3], correct: 1}, {audio: audioTest[4], correct: 0}, {audio: audioTest[5], correct: 0}]

var calib = 'stimuli/noise_calib_stim.wav'

var timeline = [];

//create a unique user id to navigate around small disconnects + html changes
var makeCode = function(len){
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxy0123456789";
    for( var i=0; i < len; i++ ){
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
};
var cookie = makeCode(10);



//flag which is set to true when a disconnect will actually cause problems in the continuation of the experiment
var needs_connection = false;


//initial screen explaining experiment
var welcome = {
  type: 'html-keyboard-response',
  stimulus: "In this experiment you will do XYZ and first we'll check you fit the criteria",
  choices: [32]
}



//survey
var badhearing = false
var noglasses = false
var badvision = false
var noheadphones = false

  var questions = {
    type: 'survey-html-form',
    html: "<p><b>Age:</b> <input name='age' type='text'/></p>" +
          "<p></p>" +

          "<b>Sexe:</b> <input name='sex' type='radio' id='H' value='H'>" +
          "<label for='H'>Homme</label>" +
          "<input name='sex' type='radio' id='F' value='F'>" +
          "<label for='F'>Femme</label>" +
          "<input name='sex' type='radio' id='N' value='N'>" +
          "<label for='N'>Neutre</label>" +
          "<p></p>"+

          "<p><b>Numero du departement de naissance:</b> <input name='pob' type='text'/></p>" +
          "<p></p>" +

          "<p><b>Langue maternelle:</b> <input name='language' type='text'/></p>" +
          "<p></p>" +

          "<b>Connexion internet:</b> <input name='connection' type='radio' id='wire' value='wire'>" +
          "<label for='wire'> Filaire </label>" +
          "<input name='connection' type='radio' id='wifi' value='wifi'>" +
          "<label for='wifi'>Wifi</label>" +
          "<p></p>"+

          "<p><b>Navigateur (exemple : Firefox, Chrome, Internet Explorer...) :</b> <input name='browser' type='text'/></p>" +
          "<p></p>" +

          "<b>Cette expérience doit être passée dans une pièce calme et à l'écart de votre entourage. Cela est-il votre cas ? </b> <input name='quietplace' type='radio' id='quiet' value='quiet'>" +
          "<label for='quiet'>Oui          </label>" +
          "<input name='quietplace' type='radio' id='notquiet' value='notquiet'>" +
          "<label for='vbad'>Non</label>"+
          "<p></p>" +

          "<b>Votre audition est-elle:</b> <input name='hearing' type='radio' id='hfine' value='fine'>" +
          "<label for='hfine'>Normale          </label>" +
          "<input name='hearing' type='radio' id='hbad' value='bad'>" +
          "<label for='hbad'>Inférieure à la normale</label>" +
          "<p></p>" +

          "<b>Votre vision non-corrigée est-elle:</b> <input name='vision' type='radio' id='vfine' value='fine'>" +
          "<label for='vfine'>Normale          </label>" +
          "<input name='vision' type='radio' id='vbad' value='bad'>" +
          "<label for='vbad'>Inférieure à la normale</label>"+
          "<p></p>"+

          "<b>Si votre vision non-corrigée est inférieure à la normale, portez-vous vos lunettes ou lentilles correctrices ? </b> <input name='glasses' type='radio' id='hasglasses' value='hasglasses'>" +
          "<label for='hasglasses'>Oui          </label>" +
          "<input name='glasses' type='radio' id='noglasses' value='noglasses'>" +
          "<label for='vbad'>Non</label>"+
          "<p></p>"+

          "<b>Pour passer cette expérience, vous devez porter des écouteurs reliés à la prise casque de votre ordinateur. Avez-vous placé ces écouteurs sur vos oreilles ?</b> <input name='headphones' type='radio' id='hpyes' value='hpyes'>" +
          "<label for='hpyes'>Oui          </label>" +
          "<input name='headphones' type='radio' id='hpno' value='hpno'>" +
          "<label for='hpno'>Non</label>"+


          "<div></div>",
    button_label: 'Continuer',
    on_finish: function(data){
      if (JSON.parse(data.responses).hearing == 'bad'){
        console.log('bad hearing')
        badhearing = true
      }
      if (JSON.parse(data.responses).vision == 'bad'){
        console.log('bad vision')
        badvision = true
      }
      if (JSON.parse(data.responses).glasses == 'noglasses'){
        console.log('no glasses')
        noglasses = true
      }
      if (JSON.parse(data.responses).headphones == 'hpno'){
        console.log('no headphones')
        noheadphones = true
      }
    }
  };

//dismiss people who fail certain criteria
var noBadHearing = {
  type: 'html-keyboard-response',
  stimulus: "Pour passer cette expérience, il est nécessaire d’avoir une audition normale. Nous vous remercions.",
  response_ends_trial: false
}

var noNoGlasses= {
  type: 'html-keyboard-response',
  stimulus: "Pour passer cette expérience, il est nécessaire d’avoir  une vision normale ou de porter des verres correcteurs . Nous vous remercions.",
  response_ends_trial: false
}

var noNoHeadphones= {
  type: 'html-keyboard-response',
  stimulus: "Pour passer cette expérience, vous devez porter des écouteurs. Nous vous remercions.",
  response_ends_trial: false
}

var suitableCond1 = {
  timeline: [noBadHearing],
  conditional_function: function(){
  if (badhearing == true){
    return true
  } else {
    return false
  }
}
}

var suitableCond2 = {
  timeline: [noNoGlasses],
  conditional_function: function(){
    if (badhearing == false && badvision == true && noglasses == true){
      return true
    } else {
      return false
    }
  }
}

var suitableCond3 = {
  timeline: [noNoHeadphones],
  conditional_function: function(){
    if (badhearing == false && badvision == false && noheadphones == true){
      return true
    } else {
      return false
    }
  }
}


//headphone test
var num_correct = 0

var headphoneIntro = {timeline: [
  {type: 'html-button-response',
  stimulus: "<p>RÉGLAGE DU VOLUME</p>" +

"<p>Veuillez placer vos écouteurs sur vos oreilles.</p>"+

"<p>Régler le volume de votre ordinateur à environ 25% du maximum.</p>"+

"<p>Cliquer sur Play, puis augmenter graduellement le volume jusqu'à ce que le bruit de calibration soit à un niveau élevé mais confortable.</p>"+

"<p>Rejouer le bruit de calibration autant de fois que vous le souhaitez.</p>"+

"<audio controls> <source src='stimuli/noise_calib_stim.wav' type='audio/wav'></audio>"+

"<p>Cliquer sur Continuer quand la calibration est achevée.</p>",
choices: ['Continuer']
},

{type: 'html-button-response',
stimulus: "<p>Vous allez entendre trois séquences de trois sons chacune.</p>"+

"<p>Pour chaque séquence, dites lequel des trois sons est le plus faible – 1, 2, ou 3 ?</p>"+

"<p>Attention, tendez-bien l’oreille, vous n’entendrez chaque séquence qu’une fois !</p>",
choices: ['Continuer']
}
]}

 var headphoneTest = {timeline: [

   {
   type: 'audio-button-response',
   prompt: 'Quel est le son le plus faible?',
   stimulus: jsPsych.timelineVariable('stimulus'),
   choices: [1, 2, 3],
   on_finish: function(data){
     if (data.button_pressed == jsPsych.timelineVariable('correct', true)){
       num_correct += 1
     }
     console.log(num_correct)
   }}
 ],
timeline_variables: [
  {stimulus: audioTestCorrect[0].audio, correct:audioTestCorrect[0].correct},
  {stimulus: audioTestCorrect[1].audio, correct:audioTestCorrect[1].correct},
  {stimulus: audioTestCorrect[2].audio, correct:audioTestCorrect[2].correct},
  {stimulus: audioTestCorrect[3].audio, correct:audioTestCorrect[3].correct},
  {stimulus: audioTestCorrect[4].audio, correct:audioTestCorrect[4].correct},
  {stimulus: audioTestCorrect[5].audio, correct:audioTestCorrect[5].correct}
],
randomize_order: true
};

//conditional trial for those who pass the test

var headphoneFail = {
  type: 'html-button-response',
  stimulus: 'Veuillez utiliser des écouteurs et essayer encore.',
  choices: ['Next'],
  on_finish: function(){
    num_correct = 0
  }
}

var headphoneCond = {
  timeline: [headphoneFail, headphoneTest],
  conditional_function: function(){
    if (num_correct >= 5) {
      return false
    } else {
      return true
    }
  }
}


//connect to a partner that has also passed these parts of the experiment
var connect = {
  type: 'html-keyboard-response',
  stimulus: "We will now connect you to a group in order to continue with the experiment, please press the spacebar to be connected",
  choices: [32],
  on_finish: function(){
      socket.emit('new player', {cookie: cookie, num_players: num_players, num_test_trials: num_test_trials});
    }
}



var num_connected = 1;
socket.on('player connect', function(data){
  num_connected = data;
});


var room_full = false;

socket.on('room full', function(){
  needs_connection = true;
  room_full = true;
});

socket.on('disconnect before start', function(data){
  num_connected = data
});

var client_join = {
  type: 'html-keyboard-response',
  stimulus: function(){return '<p>Please wait while we find other players.</p>'+
            '<p>'+num_connected+ '/'+(num_players-players_disconnected)+' connected.</p>'},
  response_ends_trial: false,
  trial_duration: 200
};
var client_join_loop = {
  timeline: [client_join],
  loop_function: function(){
    if (room_full == false){
      return true
    } else {
      return false
    }
  }
};


//tell the plugin what session we have joined
var session_id;
socket.on('session id', function(data){
  session_id = data;
  console.log(session_id);
});


//receive the shuffled things from the Server
socket.on('images', function(data){
  cardStim = data;
});
socket.on('audio', function(data){
  trial_audio = data;
});


//familiarisation trials
var cardMap = jsPsych.randomization.shuffle([
{audio: 'stimuli/1.wav', img: cardStim[0], html: "<img src="+cardStim[0]+">"},
{audio: 'stimuli/4.wav', img: cardStim[1], html: "<img src="+cardStim[1]+">"},
{audio: 'stimuli/13.wav', img: cardStim[2], html: "<img src="+cardStim[2]+">"},
{audio: 'stimuli/16.wav', img: cardStim[3], html: "<img src="+cardStim[3]+">"}
]);

var familiarisation_start = {
  type: 'html-keyboard-response',
  stimulus: '<p>This is the familiarisation.</p>'+
            '<p>Press space to begin.</p>',
  choices: [32],
  on_finish: function(data){
    data.session = session_id
  }
};

var familiarisation = {timeline: [{
  type: 'audio-keyboard-response',
  choices: [32],
  stimulus: jsPsych.timelineVariable('audio'),
  prompt: jsPsych.timelineVariable('html')
  }],
  timeline_variables: [cardMap[0], cardMap[0], cardMap[0], cardMap[0], cardMap[0],
                       cardMap[1], cardMap[1], cardMap[1], cardMap[1], cardMap[1],
                       cardMap[2], cardMap[2], cardMap[2], cardMap[2], cardMap[2],
                       cardMap[3], cardMap[3], cardMap[3], cardMap[3], cardMap[3]]
};



//training trials
var training_start = {
  type: 'html-keyboard-response',
  stimulus: '<p>This is the training.</p>'+
            '<p>You can move using the arrow keys <img src="stimuli/arrowKeys.png", width=100 height=50></p>' +
            '<p>Press space to begin.</p>',
  choices: [32]
};


var chosen;
var correct;
var training = {
  timeline: [{
      type: 'multi-training',
      images: function(){return cardStim},
      stimulus: jsPsych.timelineVariable('audio'),
      on_finish: function(data){
        chosen = data.image_choice;
        data.correct = jsPsych.timelineVariable('img', true);
        cardStim = jsPsych.randomization.shuffle(cardStim);
      }
   },
   {
    type: 'html-keyboard-response',
    stimulus: function(){
      var stim;
      if (chosen!='No choice'){
        stim = '<p>You chose:<img src='+chosen+'></p>'
      } else {
        stim = 'You did not choose an image.'
      }
      stim = stim+'<p>The correct image was:<img src='+jsPsych.timelineVariable('img', true)+'></p>'
      return stim
    },
    trial_duration: 3000,
    response_ends_trial: false
  }
],
timeline_variables: cardMap,
randomize_order: true,
repetitions: 4
};


//wait for partner to catch up if necessary and then begin coordination trials
//might add in a small independent testing phase first but not sure
var testing_start = {
  type: 'html-keyboard-response',
  stimulus: 'Now we will do the coordinated testing. Press space to wait for your group.',
  choices: [32],
  on_finish: function(){
    socket.emit('want to start', session_id)
  }
};


var num_ready = 1;
socket.on('ready for test', function(data){
  console.log('ready for test');
  num_ready = data;
});

var room_ready = false;
socket.on('begin test', function(data){
  console.log('begin test');
  cardStim = data;
  room_ready = true
});
var test_join = {
  type: 'html-keyboard-response',
  stimulus: function(){return '<p>Please wait for the other people in your group to catch up.</p>'+
            '<p>'+num_ready+ '/'+(num_players-players_disconnected)+' connected.</p>'},
  response_ends_trial: false,
  trial_duration: 200
};
var test_join_loop = {
  timeline: [test_join],
  loop_function: function(){
    if (room_ready == false){
      return true
    } else {
      return false
    }
  }
};


var trials_done = 0;
var num_agreed = 0;
socket.on('agreement', function(){num_agreed++});

var testing = {
  timeline:[{
  type: 'multi-experiment',
  images: function(){return cardStim},
  stimulus: function(){return trial_audio},
  cookie: function(){return cookie},
  session_id: function(){return session_id},
  continuous_feedback: true,
  num_players: num_players,
  on_finish: function(){
    trials_done++
  }
},
{
  type: 'html-keyboard-response',
  stimulus: 'Please wait',
  response_ends_trial: false,
  trial_duration: 2000
}]
};


//after every 16 trials display information about how much participants have agreed
var display_score = {
  type: 'html-keyboard-response',
  stimulus: function(){return 'You agreed with your group on '+num_agreed+'/16 trials.'},
  response_ends_trial: false,
  trial_duration: 4000,
  on_finish: function(){
    num_agreed = 0
  }
};

var display_conditional = {
  timeline: [display_score],
  conditional_function: function(){
    if (trials_done % 16 == 0){
      return true;
    } else {
      return false;
    }
  }
}


//the loop that ends when the server says the prescribed number of trials hav e been completed
var end_test = false;
var test_loop = {
  timeline: [testing, display_conditional],
  loop_function: function(){
    if (end_test == false){
      return true
    } else {
      return false
    }
  }
};
socket.on('end test', function(){
  needs_connection = false;
  end_test = true;
});

//post test to see if this has had a lasting effect
var post_test_intro = {
  type: 'html-keyboard-response',
  stimulus: "Now we're going to do the same thing again but it's just you alone again.",
  choices: [32]
};

var post_test = {
  timeline: [{
  type: 'multi-training',
  images: function (){return jsPsych.randomization.shuffle(cardStim)},
  stimulus: jsPsych.timelineVariable('stimulus')
  },
  {
    type: 'html-keyboard-response',
    stimulus: 'Please wait',
    response_ends_trial: false,
    trial_duration: 2000
  }
],
  timeline_variables: [
    {stimulus: test_audio[0]}, {stimulus: test_audio[1]}, {stimulus: test_audio[2]}, {stimulus: test_audio[3]},
    {stimulus: test_audio[4]}, {stimulus: test_audio[5]}, {stimulus: test_audio[6]}, {stimulus: test_audio[7]},
    {stimulus: test_audio[8]}, {stimulus: test_audio[9]}, {stimulus: test_audio[10]}, {stimulus: test_audio[11]},
    {stimulus: test_audio[12]}, {stimulus: test_audio[13]}, {stimulus: test_audio[14]}, {stimulus: test_audio[15]}
  ],
  randomize_order: true
};

var ending = {
  type: 'html-keyboard-response',
  stimulus: "That's the end of the experiment. Thank you and please press space to send your data.",
  chocies: [32]
}


var disconnected = false;
var players_disconnected = 0;
socket.on('disconnect', function(){
  players_disconnected++
  if(needs_connection == true && players_disconnected >= able_to_lose){
    disconnected = true;
    var time = jsPsych.totalTime();
    jsPsych.endExperiment();
  //  alert('Your partner disconnected!');
  }
})

//initialise experiment
jsPsych.init({
  timeline:[
    //welcome, questions, suitableCond1, suitableCond2, suitableCond3, headphoneIntro, headphoneTest, headphoneCond,
    //everything from here requires a connection to a group
    connect, client_join_loop, familiarisation_start, familiarisation,
    training_start, training,
    testing_start, test_join_loop, test_loop,
    //connection no longer required
    post_test_intro, post_test, ending
  ],
  preload_audio: [test_audio, audioTest, calib],
  preload_images: [cardStim],
  on_finish: function(){
    //when you put this back in remember that the mongo thing in app needs to be changed back
    $.ajax({
      type: 'POST',
      url: '/experiment-data',
      data: jsPsych.data.get().json(),
      contentType: 'application/json',
      timeout: 1000,
      success: function(){
        console.log('success');
        if (disconnected == false){
          window.location.href = 'finish';
        } else {
          window.location.href = 'disconnect'
        };
        socket.emit('end of experiment', session_id)
      },
      error: function(){
        alert('Your data was not saved')
        window.location.href = 'finish';
      }
    })
  }
});

</script>
</html>
