<!DOCTYPE html>
<html>
  <head>
    <title>Multiplayer Experiment</title>
    <script src='jspsych/jspsych.js'></script>
    <script src="socket.io/socket.io.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-external-html.js"></script>
    <script src="jspsych/plugins/jspsych-multi-experiment.js"></script>
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>

<script>
var socket = io();
var timeline = [];
var test_audio = ["stimuli/1.wav", "stimuli/2.wav", "stimuli/3.wav", "stimuli/4.wav",
                "stimuli/5.wav", "stimuli/6.wav", "stimuli/7.wav", "stimuli/8.wav",
                "stimuli/9.wav", "stimuli/10.wav", "stimuli/11.wav", "stimuli/12.wav",
                "stimuli/13.wav", "stimuli/14.wav", "stimuli/15.wav", "stimuli/16.wav"];

var cardStim = ["stimuli/1001.jpg", "stimuli/2001.jpg", "stimuli/3001.jpg", "stimuli/4001.jpg"]
var trial_audio;

//create a unique user id to navigate around small disconnects + html changes
var makeCode = function(len){
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxy0123456789";
    for( var i=0; i < len; i++ ){
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
};
var cookie = makeCode(10);



var start = {
  type: 'html-keyboard-response',
  stimulus: '<p>You will hear a word, please use the arrow keys to move to the image that you think corresponds to the word.</p>'+
            '<p>Press space to find a partner;</p>',
  choices: [32],
  on_finish: function(){
      socket.emit('new player', cookie);
  }
};


var room_full = false;
socket.on('room full', function(){
  room_full = true
});
var client_join = {
  type: 'html-keyboard-response',
  stimulus: 'Please wait while we find you a partner.',
  response_ends_trial: false,
  trial_duration: 500
};
var client_join_loop = {
  timeline: [client_join],
  loop_function: function(){
    if (room_full == false){
      return true
    } else {
      return false
    }
  }
};


//tell the plugin what session we have joined
var session_id;
socket.on('session id', function(data){
  session_id = data;
  console.log(session_id)
});


//receive the shuffled things from the Server
socket.on('images', function(data){
  cardStim = data;
});
socket.on('audio', function(data){
  trial_audio = data;
});



var trial = {
  timeline:[{
  type: 'multi-experiment',
  images: function(){return cardStim},
  stimulus: function(){return trial_audio},
  cookie: function(){return cookie},
  session_id: function(){return session_id},
  continuous_feedback: false
},
{
  type: 'html-keyboard-response',
  stimulus: 'Please wait',
  response_ends_trial: false,
  trial_duration: 2000
}]
};

var end_test = false;
var test_loop = {
  timeline: [trial],
  loop_function: function(){
    if (end_test == false){
      return true
    } else {
      return false
    }
  }
};
socket.on('end test', function(){
  end_test = true
});





jsPsych.init({
  timeline:[
    start, client_join_loop, test_loop
  ],
  preload_audio: [test_audio],
  preload_images: [cardStim],
  on_finish: function(){jsPsych.data.displayData()}
});

</script>
</html>
